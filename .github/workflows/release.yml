name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building version: ${VERSION}"

      - name: Build release binaries
        run: |
          echo "Building release binaries for version ${VERSION}..."
          mkdir -p bin
          
          # Build for Linux amd64
          echo "Building for Linux amd64..."
          GOOS=linux GOARCH=amd64 go build -ldflags "-X github.com/mule-ai/search/pkg/version.Version=${VERSION} -X github.com/mule-ai/search/pkg/version.BuildDate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -o bin/search-linux-amd64 ./cmd/search
          
          # Build for Linux arm64
          echo "Building for Linux arm64..."
          GOOS=linux GOARCH=arm64 go build -ldflags "-X github.com/mule-ai/search/pkg/version.Version=${VERSION} -X github.com/mule-ai/search/pkg/version.BuildDate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -o bin/search-linux-arm64 ./cmd/search
          
          # Build for macOS amd64 (Intel)
          echo "Building for macOS amd64..."
          GOOS=darwin GOARCH=amd64 go build -ldflags "-X github.com/mule-ai/search/pkg/version.Version=${VERSION} -X github.com/mule-ai/search/pkg/version.BuildDate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -o bin/search-darwin-amd64 ./cmd/search
          
          # Build for macOS arm64 (Apple Silicon)
          echo "Building for macOS arm64..."
          GOOS=darwin GOARCH=arm64 go build -ldflags "-X github.com/mule-ai/search/pkg/version.Version=${VERSION} -X github.com/mule-ai/search/pkg/version.BuildDate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -o bin/search-darwin-arm64 ./cmd/search
          
          # Build for Windows amd64
          echo "Building for Windows amd64..."
          GOOS=windows GOARCH=amd64 go build -ldflags "-X github.com/mule-ai/search/pkg/version.Version=${VERSION} -X github.com/mule-ai/search/pkg/version.BuildDate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -o bin/search-windows-amd64.exe ./cmd/search
          
          # Generate checksums
          cd bin
          sha256sum * > checksums.txt
          cd ..
          
          echo "Release binaries built:"
          ls -lh bin/

      - name: Create archives
        run: |
          cd bin
          
          # Create tar.gz for Unix-like systems
          tar -czf search-linux-amd64.tar.gz search-linux-amd64
          tar -czf search-linux-arm64.tar.gz search-linux-arm64
          tar -czf search-darwin-amd64.tar.gz search-darwin-amd64
          tar -czf search-darwin-arm64.tar.gz search-darwin-arm64
          
          # Create zip for Windows
          zip search-windows-amd64.zip search-windows-amd64.exe
          
          # Add checksums to archives
          sha256sum *.tar.gz *.zip >> checksums.txt
          
          ls -lh

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          ## Search CLI ${VERSION}

          ### Installation

          \`\`\`bash
          # Linux (amd64)
          curl -L -o search "https://github.com/mule-ai/search/releases/download/${VERSION}/search-linux-amd64"
          chmod +x search
          sudo mv search /usr/local/bin/

          # macOS (Intel)
          curl -L -o search "https://github.com/mule-ai/search/releases/download/${VERSION}/search-darwin-amd64"
          chmod +x search
          sudo mv search /usr/local/bin/

          # macOS (Apple Silicon)
          curl -L -o search "https://github.com/mule-ai/search/releases/download/${VERSION}/search-darwin-arm64"
          chmod +x search
          sudo mv search /usr/local/bin/

          # Windows (PowerShell)
          Invoke-WebRequest -OutFile search.exe "https://github.com/mule-ai/search/releases/download/${VERSION}/search-windows-amd64.exe"
          \`\`\`

          ### Verify Checksums

          \`\`\`bash
          # Download and verify
          curl -L -O "https://github.com/mule-ai/search/releases/download/${VERSION}/checksums.txt"
          sha256sum -c checksums.txt
          \`\`\`

          ### What's Changed

          See [CHANGELOG.md](https://github.com/mule-ai/search/blob/main/CHANGELOG.md) for details.
          EOF
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Search CLI ${{ env.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            bin/search-*.tar.gz
            bin/search-*.zip
            bin/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: search-${{ env.VERSION }}
          path: bin/
          retention-days: 30
